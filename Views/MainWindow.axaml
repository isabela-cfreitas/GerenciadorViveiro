<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:GerenciadorViveiro.ViewModels"
        xmlns:converters="using:GerenciadorViveiro"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="550"
        x:Class="GerenciadorViveiro.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Gerenciador de Vendas"
        Width="900" Height="550">

    <Window.Resources>
        <converters:DecimalConverter x:Key="DecimalConverter"/>
        <converters:IntegerConverter x:Key="IntegerConverter"/>
    </Window.Resources>

    <TabControl x:Name="MainTabControl" SelectionChanged="OnTabSelectionChanged">
        <!-- TAB CONFIGURAÇÕES -->
        <TabItem Header="Configurações" FontSize="20">
            <Grid Margin="20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="20"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Título -->
                <TextBlock Grid.Row="0"
                           Text="Configuração da Pasta Base"
                           FontSize="18"
                           FontWeight="Bold"
                           Margin="0,0,0,20"/>

                <!-- Pasta Base -->
                <StackPanel Grid.Row="2" Spacing="10">
                    <TextBlock Text="Selecione a pasta onde os dados serão salvos:"
                               FontWeight="SemiBold"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox Grid.Column="0"
                                 Text="{Binding ConfiguracoesVM.PastaBase, Mode=TwoWay}"
                                 Watermark="Selecione uma pasta (ex: C:/Users/Usuario/Dropbox)"
                                 Margin="0,0,10,0"/>
                        <Button Grid.Column="1"
                                Content="Procurar"
                                Click="SelecionarPastaBase"
                                Padding="15,8"/>
                    </Grid>
                    <TextBlock TextWrapping="Wrap"
                               FontSize="11"
                               Foreground="Gray"
                               Margin="5,0,0,0">
                        <Run Text="Os seguintes arquivos e pastas serão criados automaticamente:"/>
                        <LineBreak/>
                        <Run Text="• vendas.xlsx (arquivo principal de vendas)"/>
                        <LineBreak/>
                        <Run Text="• Custos/ (pasta com arquivos de custos mensais)"/>
                        <LineBreak/>
                        <Run Text="• Balancos/ (pasta para exportar balanços)"/>
                        <LineBreak/>
                        <Run Text="• Frequencias/ (pasta para exportar frequências)"/>
                    </TextBlock>
                </StackPanel>

                <!-- Info adicional -->
                <Border Grid.Row="3"
                        Background="#F5F5F5"
                        CornerRadius="5"
                        Padding="15"
                        Margin="0,30,0,0"
                        VerticalAlignment="Top">
                    <StackPanel Spacing="8">
                        <TextBlock Text="ℹ️ Importante:"
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="• Configure a pasta base antes de usar as outras abas"
                                   TextWrapping="Wrap"/>
                        <TextBlock Text="• Frequências e Balanços podem ser exportados nas respectivas abas"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>
            </Grid>
        </TabItem>

        <!-- TAB VENDAS -->
        <TabItem Header="Vendas" FontSize="20">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Aviso se pasta não configurada -->
                <Border Grid.Row="0"
                        Background="#FFF3CD"
                        BorderBrush="#FFC107"
                        BorderThickness="1"
                        CornerRadius="5"
                        Padding="15"
                        Margin="0,0,0,10"
                        IsVisible="{Binding !ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="⚠️ Configure a pasta base na aba Configurações antes de usar esta funcionalidade"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>
                </Border>

                <!-- Filtro -->
                <StackPanel Grid.Row="0"
                            Orientation="Horizontal"
                            VerticalAlignment="Top"
                            Margin="0,0,0,8"
                            IsVisible="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="Cliente:"
                            VerticalAlignment="Center"
                            Margin="0,0,6,0"/>
                    <TextBox Width="180"
                            Height="28"
                            Watermark="Filtrar..."
                            Text="{Binding VendasVM.FiltroCliente, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- Tabela -->
                <Border Grid.Row="1"
                    BorderBrush="#CCCCCC"
                    BorderThickness="1"
                    CornerRadius="5"
                    IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <DataGrid x:Name="VendasDataGrid"
                        ItemsSource="{Binding VendasVM.VendasFiltradas}"
                        AutoGenerateColumns="False"
                        IsReadOnly="False"
                        GridLinesVisibility="All"
                        SelectionMode="Extended"
                        CanUserReorderColumns="True"
                        CanUserResizeColumns="True">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Data" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Data, StringFormat='{}{0:dd/MM/yyyy}'}" 
                                                VerticalAlignment="Center" 
                                                Margin="5,0"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <CalendarDatePicker SelectedDate="{Binding Data, Mode=TwoWay}" 
                                                            HorizontalAlignment="Stretch"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Planta" 
                                                Binding="{Binding Planta}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Quantidade" 
                                                Binding="{Binding Quantidade}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Valor unitário" 
                                                Binding="{Binding Valor, Converter={StaticResource DecimalConverter}}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Valor total" 
                                                Binding="{Binding ValorTotal, StringFormat='C2'}" 
                                                IsReadOnly="True"
                                                Width="*"/>
                            <DataGridTextColumn Header="Cliente" 
                                                Binding="{Binding Cliente}" 
                                                Width="*"/>
                            <DataGridTemplateColumn Header="Forma de Pagamento" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FormaPagamento}" 
                                                VerticalAlignment="Center" 
                                                Margin="5,0"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox SelectedItem="{Binding FormaPagamento, Mode=TwoWay}"
                                                HorizontalAlignment="Stretch">
                                            <x:String>Dinheiro</x:String>
                                            <x:String>Pix</x:String>
                                            <x:String>Cartão de Crédito</x:String>
                                            <x:String>Cartão de Débito</x:String>
                                            <x:String>Cheque</x:String>
                                            <x:String>Anotado</x:String>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>

                <!-- Botões -->
                <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Margin="0,10,0,0"
                    IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <Button Content="Nova Linha" 
                            Command="{Binding VendasVM.NovaLinhaCommand}"
                            Background="#4CAF50" Foreground="White"
                            Padding="20,8" Margin="5"/>
                    <Button Content="Excluir Linha(s)" 
                            Command="{Binding VendasVM.ExcluirLinhasCommand}"
                            Background="#F44336" Foreground="White"
                            Padding="20,8" Margin="5"/>
                    <Button Content="Salvar" 
                            Command="{Binding VendasVM.SalvarCommand}"
                            Background="#2196F3" Foreground="White"
                            Padding="20,8" Margin="5"/>
                </StackPanel>
            </Grid>
        </TabItem>
        
        <!-- TAB FREQUÊNCIAS -->
        <TabItem Header="Frequências" Tapped="CalcularFrequencias" FontSize="20">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Aviso se pasta não configurada -->
                <Border Grid.Row="0"
                        Background="#FFF3CD"
                        BorderBrush="#FFC107"
                        BorderThickness="1"
                        CornerRadius="5"
                        Padding="15"
                        Margin="0,0,0,10"
                        IsVisible="{Binding !ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="⚠️ Configure a pasta base na aba Configurações antes de usar esta funcionalidade"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>
                </Border>

                <!-- Seleção de período -->
                <StackPanel Grid.Row="1" 
                            Orientation="Horizontal" 
                            Margin="0,0,0,10"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="Ano:"
                            VerticalAlignment="Center"
                            Margin="0,0,5,0"/>
                    <TextBox Width="100"
                        Text="{Binding FrequenciasVM.AnoSelecionado, Mode=TwoWay, Converter={StaticResource IntegerConverter}}"
                        Watermark="Ano"/>

                    <TextBlock Text="Mês:"
                            VerticalAlignment="Center"
                            Margin="15,0,5,0"/>
                    <TextBox Width="80"
                        Margin="15,0,0,0"
                        Text="{Binding FrequenciasVM.MesSelecionado, Mode=TwoWay, Converter={StaticResource IntegerConverter}}"
                        Watermark="Mês (1–12)"/>
                </StackPanel>

                <!-- Mensagem de erro -->
                <TextBlock Grid.Row="2"
                           Text="{Binding FrequenciasVM.MensagemErro}"
                           Foreground="Red"
                           FontWeight="SemiBold"
                           Margin="0,0,0,10"
                           IsVisible="{Binding FrequenciasVM.MensagemErro, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                <!-- Tabela -->
                <Border Grid.Row="3" 
                        BorderBrush="#CCCCCC" 
                        BorderThickness="1" 
                        CornerRadius="5"
                        IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <DataGrid x:Name="FrequenciasGrid"
                        ItemsSource="{Binding FrequenciasVM.Frequencias}"
                        AutoGenerateColumns="False"
                        IsReadOnly="True"
                        GridLinesVisibility="All"
                        SelectionMode="Extended"
                        CanUserReorderColumns="True"
                        CanUserResizeColumns="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Planta"
                                                Binding="{Binding Planta}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Quantidade" 
                                                Binding="{Binding Quantidade}"
                                                Width="*"/>
                            <DataGridTextColumn Header="Valor" 
                                                Binding="{Binding Valor, Converter={StaticResource DecimalConverter}}" 
                                                Width="*"/>
                            <DataGridTextColumn Header="Valor total" 
                                                Binding="{Binding ValorTotal, StringFormat='C2'}" 
                                                Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>

                <!-- Botão Exportar -->
                <StackPanel Grid.Row="4" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            Margin="0,10,0,0"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <Button Content="Exportar para .xlsx" 
                            Command="{Binding FrequenciasVM.ExportarFrequenciasCommand}"
                            Background="#4CAF50" 
                            Foreground="White"
                            Padding="20,8" 
                            Margin="5"/>
                </StackPanel>
            </Grid>
        </TabItem>

        <!-- TAB CUSTOS -->
        <TabItem Header="Custos" FontSize="20">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Aviso se pasta não configurada -->
                <Border Grid.Row="0"
                        Background="#FFF3CD"
                        BorderBrush="#FFC107"
                        BorderThickness="1"
                        CornerRadius="5"
                        Padding="15"
                        Margin="0,0,0,10"
                        IsVisible="{Binding !ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="⚠️ Configure a pasta base na aba Configurações antes de usar esta funcionalidade"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>
                </Border>

                <!-- Seleção mês/ano -->
                <StackPanel Grid.Row="1" 
                            Orientation="Horizontal" 
                            Margin="0,0,0,10"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="Ano:" Margin="0,0,5,0"/>
                    <TextBox Width="100"
                        Text="{Binding CustosVM.AnoSelecionado, Mode=TwoWay, Converter={StaticResource IntegerConverter}}"
                        Watermark="Ano"/>

                    <TextBlock Text="Mês:" Margin="15,0,5,0"/>
                    <TextBox Width="80"
                        Margin="15,0,0,0"
                        Text="{Binding CustosVM.MesSelecionado, Mode=TwoWay, Converter={StaticResource IntegerConverter}}"
                        Watermark="Mês (1–12)"/>
                </StackPanel>

                <!-- Mensagem de erro -->
                <TextBlock Grid.Row="2"
                           Text="{Binding CustosVM.MensagemErro}"
                           Foreground="Red"
                           FontWeight="SemiBold"
                           Margin="0,0,0,10"
                           IsVisible="{Binding CustosVM.MensagemErro, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                <!-- Tabela -->
                <DataGrid Grid.Row="3"
                        x:Name="CustosDataGrid"
                        ItemsSource="{Binding CustosVM.Custos}"
                        AutoGenerateColumns="False"
                        GridLinesVisibility="All"
                        SelectionMode="Extended"
                        CanUserReorderColumns="True"
                        CanUserResizeColumns="True"
                        IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Atividade" Binding="{Binding Atividade}"/>
                        <DataGridTextColumn Header="Elemento" Binding="{Binding Elemento}"/>
                        <DataGridTextColumn Header="Quantidade" Binding="{Binding Quantidade}"/>
                        <DataGridTextColumn Header="Valor Total" Binding="{Binding ValorTotal}"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Botões -->
                <StackPanel Grid.Row="4" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            Margin="0,10,0,0"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <Button Content="Nova Linha" 
                            Command="{Binding CustosVM.NovaLinhaCommand}"
                            Background="#4CAF50" Foreground="White"
                            Padding="20,8" Margin="5"/>
                    <Button Content="Excluir Linha(s)" 
                            Command="{Binding CustosVM.ExcluirLinhasCommand}"
                            Background="#F44336" Foreground="White"
                            Padding="20,8" Margin="5"/>
                    <Button Content="Salvar" 
                            Command="{Binding CustosVM.SalvarCustosCommand}"
                            Background="#2196F3" Foreground="White"
                            Padding="20,8" Margin="5"/>
                </StackPanel>
            </Grid>
        </TabItem>

        <!-- TAB BALANÇO -->
        <TabItem Header="Balanço" FontSize="20">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Aviso se pasta não configurada -->
                <Border Grid.Row="0"
                        Background="#FFF3CD"
                        BorderBrush="#FFC107"
                        BorderThickness="1"
                        CornerRadius="5"
                        Padding="15"
                        Margin="0,0,0,10"
                        IsVisible="{Binding !ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="⚠️ Configure a pasta base na aba Configurações antes de usar esta funcionalidade"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>
                </Border>

                <!-- Seleção apenas de ano -->
                <StackPanel Grid.Row="1" 
                            Orientation="Horizontal" 
                            Margin="0,0,0,10"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <TextBlock Text="Ano:" Margin="0,0,5,0" VerticalAlignment="Center"/>
                    <TextBox Width="100"
                        Text="{Binding BalancoVM.AnoSelecionado, Mode=TwoWay, Converter={StaticResource IntegerConverter}}"
                        Watermark="Ano"/>
                    <TextBlock Text="(Visualização anual - 12 meses)" 
                            Margin="15,0,0,0" 
                            VerticalAlignment="Center"
                            Foreground="Gray"
                            FontSize="11"/>
                </StackPanel>

                <!-- Mensagem de erro -->
                <TextBlock Grid.Row="2"
                           Text="{Binding BalancoVM.MensagemErro}"
                           Foreground="Red"
                           FontWeight="SemiBold"
                           Margin="0,0,0,10"
                           IsVisible="{Binding BalancoVM.MensagemErro, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                <!-- Tabela -->
                <DataGrid Grid.Row="3"
                        x:Name="BalancoDataGrid"
                        ItemsSource="{Binding BalancoVM.Balancos}"
                        AutoGenerateColumns="False"
                        GridLinesVisibility="All"
                        SelectionMode="Extended"
                        CanUserReorderColumns="True"
                        CanUserResizeColumns="True"
                        IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Mês" Binding="{Binding NomeMes}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="Renda Bruta" Binding="{Binding RendaBruta, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="Custo Total" Binding="{Binding CustoTotal, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="Margem Lucro" Binding="{Binding MargemLucro, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="% Luís" Binding="{Binding PercentualLuis}" Width="80"/>
                        <DataGridTextColumn Header="% Pedro" Binding="{Binding PercentualPedro}" Width="80"/>
                        <DataGridTextColumn Header="% Viveiro" Binding="{Binding PercentualViveiro}" Width="80"/>
                        <DataGridTextColumn Header="R$ Luís" Binding="{Binding ValorLuis, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="R$ Pedro" Binding="{Binding ValorPedro, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Header="R$ Viveiro" Binding="{Binding ValorViveiro, StringFormat='C2'}" IsReadOnly="True" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Botões -->
                <StackPanel Grid.Row="4" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Center" 
                            Margin="0,10,0,0"
                            IsEnabled="{Binding ConfiguracoesVM.PastaConfigurada}">
                    <Button Content="Exportar para .xlsx" 
                            Command="{Binding BalancoVM.ExportarBalancoCommand}"
                            Background="#4CAF50" 
                            Foreground="White"
                            Padding="20,8" 
                            Margin="5"/>
                </StackPanel>
            </Grid>
        </TabItem>
    </TabControl>
</Window>